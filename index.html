<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>tiny live transcription</title>
  <meta name="theme-color" content="#0b0c10">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>tiny live transcription</h1>

  <div class="container">
    <p class="warn">this demo sends audio straight to deepgram from your browser and uses a browser-exposed key. use a restricted/temporary key for testing only.</p>

    <!-- controls -->
    <div class="controls" role="group" aria-label="connection settings">
      <label for="dgKey">
        deepgram api key
        <input id="dgKey" type="password" placeholder="dg_xxxxxxxxxxxxxxxxx" autocomplete="off" />
      </label>

      <label for="lang" style="min-width:180px;">
        language
        <input id="lang" type="text" value="en" />
      </label>
    </div>

    <!-- transcript panel -->
    <div id="transcript" aria-live="polite" aria-atomic="false"></div>
  </div>

  <!-- animated decorative waveform (css-only) -->
  <div class="wave-wrap"><div class="wave"></div></div>

  <!-- bottom action bar -->
  <div class="action-bar" role="toolbar" aria-label="recording controls">
    <div class="action-bar-inner">
      <div class="action-left"></div>

      <div class="action-center">
        <!-- START: big round red button with mic icon -->
        <button id="start" aria-label="start recording" title="start recording">
          <!-- mic svg -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zM5 11a1 1 0 0 1 2 0 5 5 0 0 0 10 0 1 1 0 1 1 2 0 7 7 0 0 1-6 6.93V20h3a1 1 0 1 1 0 2H8a1 1 0 1 1 0-2h3v-2.07A7 7 0 0 1 5 11z" />
          </svg>
        </button>

        <!-- STOP: big dark pill with stop icon -->
        <button id="stop" aria-label="stop recording" title="stop recording" disabled>
          <!-- stop svg -->
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7 7h10v10H7z" />
          </svg>
        </button>
      </div>

      <div class="action-right">
        <span id="status">idle</span>
      </div>
    </div>
  </div>

<script>
(() => {
  const startBtn = document.getElementById('start');
  const stopBtn  = document.getElementById('stop');
  const statusEl = document.getElementById('status');
  const outEl    = document.getElementById('transcript');
  const keyEl    = document.getElementById('dgKey');
  const langEl   = document.getElementById('lang');

  let ws, mediaRecorder, stream;
  let finalizedText = '';
  let partialText = '';
  let closed = false;

  function setStatus(s) { statusEl.textContent = s; }
  function render() {
    outEl.innerHTML = '';
    const finalDiv = document.createElement('div');
    finalDiv.textContent = finalizedText.trim();
    outEl.appendChild(finalDiv);

    if (partialText) {
      const partialDiv = document.createElement('div');
      partialDiv.className = 'partial';
      partialDiv.textContent = partialText;
      outEl.appendChild(partialDiv);
    }
  }

  function saveToFile() {
    const ts = new Date();
    const pad = n => String(n).padStart(2,'0');
    const name = `transcript-${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}-${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.txt`;
    const blob = new Blob([finalizedText.trim()], { type: 'text/plain;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function parseDeepgramMessage(event) {
    try {
      const data = JSON.parse(event.data);

      // detect final flag
      let isFinal = false;
      if (typeof data.is_final === 'boolean') isFinal = data.is_final;
      else if (data.channel && typeof data.channel.is_final === 'boolean') isFinal = data.channel.is_final;

      // extract transcript text
      let alt;
      if (data.channel && Array.isArray(data.channel.alternatives) && data.channel.alternatives.length) {
        alt = data.channel.alternatives[0];
      } else if (Array.isArray(data.alternatives) && data.alternatives.length) {
        alt = data.alternatives[0];
      }
      const transcript = (alt && typeof alt.transcript === 'string') ? alt.transcript : '';

      if (!transcript) return;

      if (isFinal) {
        partialText = '';
        finalizedText += (finalizedText && !finalizedText.endsWith('\n') ? ' ' : '') + transcript;
      } else {
        partialText = transcript;
      }
      render();
    } catch (_) {
      // ignore non-JSON frames
    }
  }

  async function start() {
    const key = keyEl.value.trim();
    if (!key) { alert('paste your Deepgram API key first'); return; }

    setStatus('requesting mic…');
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      setStatus('mic permission denied');
      console.error(err);
      return;
    }

    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : 'audio/webm';
    mediaRecorder = new MediaRecorder(stream, { mimeType: mime, audioBitsPerSecond: 32000 });

    const params = new URLSearchParams({
      model: 'nova-3',
      language: langEl.value || 'en',
      smart_format: 'true',
      punctuate: 'true',
      interim_results: 'true',
      vad_turnoff: '500'
    });

    ws = new WebSocket(`wss://api.deepgram.com/v1/listen?${params.toString()}`, ['token', key]);

    closed = false;
    finalizedText = '';
    partialText = '';
    render();

    ws.onopen = () => {
      setStatus('connected • streaming');
      mediaRecorder.addEventListener('dataavailable', (e) => {
        if (e.data && e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
          ws.send(e.data);
        }
      });
      mediaRecorder.start(250);
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    ws.onmessage = parseDeepgramMessage;
    ws.onerror = () => setStatus('websocket error');
    ws.onclose = () => {
      setStatus('closed');
      if (!closed) {
        try { mediaRecorder.stop(); } catch {}
        try { stream.getTracks().forEach(t => t.stop()); } catch {}
      }
      if (finalizedText.trim()) saveToFile();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };
  }

  function stop() {
    setStatus('finalizing…');
    closed = true;
    try { mediaRecorder.stop(); } catch {}
    try { stream.getTracks().forEach(t => t.stop()); } catch {}

    try {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'Finalize' }));
      }
    } catch {}

    setTimeout(() => {
      try { if (ws && ws.readyState <= 1) ws.close(1000, 'done'); } catch {}
    }, 300);
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);

  // helpful: warn if not on https (required for mic on most browsers)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    console.warn('use https (github pages does this) to access the mic.');
  }
})();
</script>
</body>
</html>
